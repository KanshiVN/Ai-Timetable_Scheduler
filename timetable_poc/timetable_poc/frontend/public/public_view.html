<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Public Timetable View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/landing.css">
</head>

<body>

    <div class="container">
        <h1>
            <span>Public</span> Schedule
        </h1>
        <p>
            View the master timetable for all classes.
            Select a class to see the weekly schedule.
        </p>

        <div class="controls">
            <label style="font-weight: 600;">Select Class:</label>
            <select id="classSelect">
                <option value="">Loading classes...</option>
            </select>
        </div>

        <div class="table-container">
            <table id="timetable">
                <thead>
                    <tr>
                        <th>Day / Time</th>
                        <th>08:30–09:30</th>
                        <th>09:30–10:30</th>
                        <th>10:45–11:45</th>
                        <th>11:45–12:45</th>
                        <th>13:30–14:30</th>
                        <th>14:30–15:30</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-muted);">
                            Please select a class to view the timetable
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
            <a href="/" class="back-link" style="color: var(--primary); text-decoration: none; font-weight: 500;">
                <i class="fa-solid fa-arrow-left"></i> Back to Home
            </a>
        </div>
    </div>

    <script>
        const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];

        const TIME_SLOTS = [
            { display: "08:30–09:30", start: "08:30:00", end: "09:30:00" },
            { display: "09:30–10:30", start: "09:30:00", end: "10:30:00" },
            { display: "10:45–11:45", start: "10:45:00", end: "11:45:00" },
            { display: "11:45–12:45", start: "11:45:00", end: "12:45:00" },
            { display: "13:30–14:30", start: "13:30:00", end: "14:30:00" },
            { display: "14:30–15:30", start: "14:30:00", end: "15:30:00" }
        ];

        async function loadClasses() {
            try {
                const res = await fetch("/api/classes");
                const classes = await res.json();

                const sel = document.getElementById("classSelect");
                sel.innerHTML = '<option value="">Select a Class</option>';

                classes.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.class_id;
                    opt.text = c.class_name;
                    sel.appendChild(opt);
                });

                // Auto-load first class if exists (optional, maybe better to wait for user)
                // if(classes.length > 0) { sel.value = classes[0].class_id; loadTimetable(); }

            } catch (e) {
                console.error("Error loading classes", e);
                document.getElementById("classSelect").innerHTML = '<option>Error loading data</option>';
            }
        }

        async function loadTimetable() {
            const classId = document.getElementById("classSelect").value;
            if (!classId) return;

            const body = document.querySelector("#timetable tbody");
            body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

            try {
                const res = await fetch(`/api/hod/timetable?class_id=${classId}`);
                const data = await res.json();

                body.innerHTML = "";

                DAYS.forEach(day => {
                    const row = document.createElement("tr");
                    const dayCell = document.createElement("th");
                    dayCell.textContent = day;
                    row.appendChild(dayCell);

                    TIME_SLOTS.forEach(slot => {
                        const cell = document.createElement("td");

                        const entry = data.find(e =>
                            e.day === day &&
                            e.start_time === slot.start &&
                            e.end_time === slot.end
                        );

                        if (entry) {
                            // Simple heuristic for type styling
                            const isLab = entry.display.includes("(");
                            cell.innerHTML = `
                            <div style="font-weight:600; color:var(--text-main);">
                                ${entry.display}
                            </div>
                        `;
                            // Highlight labs slightly?
                            if (entry.display.toLowerCase().includes("lab") || entry.display.includes("Batch")) {
                                cell.style.backgroundColor = "#EFF6FF";
                            }
                        } else {
                            cell.innerHTML = `<span style="color:#D1D5DB;">-</span>`;
                        }
                        row.appendChild(cell);
                    });
                    body.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Error loading timetable</td></tr>';
            }
        }

        document.getElementById("classSelect").onchange = loadTimetable;
        loadClasses();
    </script>

</body>

</html>